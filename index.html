<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Фейковая проверка подписки</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #060039;
      color: #d9d9d9;
      font-family: Arial, sans-serif;
      font-size: 20px;
    }

    .centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 20px;
    }

    button {
      background-color: #251897;
      color: #d9d9d9;
      border: none;
      padding: 14px 24px;
      margin: 12px;
      border-radius: 12px;
      font-size: 24px;
      cursor: pointer;
    }

    h1 {
      margin-bottom: 30px;
      font-size: 28px;
    }

    .token-container {
      margin-top: 20px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: #251897;
      padding: 8px 12px;
      border-radius: 12px;
      user-select: all;
      font-size: 16px;
      max-width: 400px;
      word-break: break-all;
    }

    .copy-btn {
      background-color: #251897;
      border: none;
      color: #d9d9d9;
      cursor: pointer;
      font-size: 18px;
      padding: 8px 16px;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      user-select: none;
    }

    .copy-btn:hover {
      background-color: #5d4ec8;
    }

    .support-text {
      margin-top: 25px;
      font-size: 18px;
    }

    .support-text a {
      color: #d9d9d9;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="centered">
    <h1 id="message">Загрузка... || Loading...</h1>
    <div id="buttons"></div>
  </div>

  <script type="module">

    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }


    import { texpereriv } from './security.js'
    localStorage.setItem('m', texpereriv || 'false'); // Устанавливаем статус технического обслуживания для теста
    const channelUsername = 'Nicknaymes2bot';
    const redirectUrl = 'main.html';
    // const blockedTokens = ['awsuoDiAt6U4LR8j', 'lgtrdfhreedghtesghtss']; ПЕРЕШЕЛ В ФАЙЛ security.js
    import { blockedTokens } from './security.js'
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytybZm3FJ48XaSfxzqk7iiTo3yR2BNf-F23pXAF6pI3lJGu6E3G5oVFPhi7xjXk3NO/exec';

    const userLang = navigator.language.startsWith('ru') ? 'ru' : 'en';
    const text = {
      ru: {
        mustSub: 'Чтобы пользоваться этим мини-приложением, надо подписаться на канал\n || To use this mini app, you must subscribe to the channel',
        check: 'Проверить\n || Check',
        subscribe: 'Подписаться\n || Subscribe',
        loading: 'Загрузка...\n|| Loading...',
        blocked: 'Ваш аккаунт заблокирован. || Your account is blocked.',
        support: 'Служба поддержки || Support service: @',
        supportBot: 'Clickerstart_bot',
        maintenance: 'Ведется техническое обслуживание!\nTechnical maintenance',
        soon: 'Скоро мы начнем техническое обслуживание\nTechnical maintenance will start soon.'
      },
    };

    const messageEl = document.getElementById('message');
    const buttonsEl = document.getElementById('buttons');
    let userToken = null;

    function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          alert('Ваш токен скопирован в буфер обмена!\nYour token copied to clipboard!');
          const copyBtn = document.querySelector('.copy-btn');
          if (copyBtn) {
            copyBtn.textContent = 'Скопировано! || Copied!';
          }
        }, () => {
          alert('Не удалось скопировать токен.');
        });
      } else {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          document.execCommand('copy');
          alert('Ваш токен скопирован в буфер обмена!\nYour token copied to clipboard!');
          const copyBtn = document.querySelector('.copy-btn');
          if (copyBtn) {
            copyBtn.textContent = 'Скопировано! || Copied!';
          }
        } catch {
          alert('Не удалось скопировать токен.');
        }
        document.body.removeChild(textArea);
      }
    }

    function createTokenContainer() {
      const tokenContainer = document.createElement('div');
      tokenContainer.className = 'token-container';

      const tokenText = document.createElement('span');
      tokenText.textContent = userToken || 'нет токена';
      tokenContainer.appendChild(tokenText);

      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      copyBtn.textContent = 'Скопировать || Copy';
      copyBtn.title = 'Скопировать токен';
      copyBtn.onclick = () => copyToClipboard(userToken);
      tokenContainer.appendChild(copyBtn);

      return tokenContainer;
    }

    function createSupportText() {
      const supportDiv = document.createElement('div');
      supportDiv.className = 'support-text';
      supportDiv.innerHTML = `${text[userLang].support}<a href="https://t.me/Clickerstart_bot" target="_blank" rel="noopener noreferrer">Clickerstart_bot</a>`;
      return supportDiv;
    }

    function showBlockedScreen() {
      messageEl.textContent = text[userLang].blocked;
      buttonsEl.innerHTML = '';
      buttonsEl.appendChild(createTokenContainer());
      buttonsEl.appendChild(createSupportText());
    }

    function showMaintenanceScreen() {
      messageEl.textContent = text[userLang].maintenance;
      buttonsEl.innerHTML = '';
      buttonsEl.appendChild(createTokenContainer());
      buttonsEl.appendChild(createSupportText());
    }

    function showSubscribeScreen() {
      messageEl.textContent = text[userLang].mustSub;
      buttonsEl.innerHTML = '';

      const subBtn = document.createElement('button');
      subBtn.textContent = text[userLang].subscribe;
      subBtn.onclick = () => window.open(`https://t.me/${channelUsername}`, '_blank');
      buttonsEl.appendChild(subBtn);

      const checkBtn = document.createElement('button');
      checkBtn.textContent = text[userLang].check;
      checkBtn.onclick = () => {
        localStorage.setItem('checkedSubscription', 'true');
        window.location.href = redirectUrl;
      };
      buttonsEl.appendChild(checkBtn);

      buttonsEl.appendChild(createTokenContainer());
      buttonsEl.appendChild(createSupportText());
    }

    function fakeCheckSubscription(startapp) {
      if (startapp) {
        window.location.href = redirectUrl;

        return;
      }

      const checkedBefore = localStorage.getItem('checkedSubscription') === 'true';
      const randomFail = Math.random() < 0.02;

      if (checkedBefore && !randomFail) {
        window.location.href = redirectUrl;

      } else {
        showSubscribeScreen();
      }
    }

    function generateToken(length = 16) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let token = '';
      for (let i = 0; i < length; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return token;
    }

    async function saveTokenToGoogle(token) {
      try {
        await fetch(`${GOOGLE_SCRIPT_URL}?token=${token}`);
      } catch (err) {
        console.warn('Ошибка отправки токена в Google таблицу:', err);
      }
    }

    async function main() {
      userToken = localStorage.getItem('userToken');

      if (!userToken) {
        userToken = generateToken(16);
        localStorage.setItem('userToken', userToken);
        await saveTokenToGoogle(userToken);
      }

      buttonsEl.appendChild(createTokenContainer());
      buttonsEl.appendChild(createSupportText());

      if (blockedTokens.includes(localStorage.getItem('userToken'))) {
        alert('Вы заблокированы!\nYou have been banned!')
        showBlockedScreen();
        return;
      }

      if (texpereriv.toLowerCase() === 'скоро') {
        alert(text[userLang].soon);
      } else if (texpereriv.toLowerCase() === 'уже') {
        alert(text[userLang].maintenance);
        showMaintenanceScreen();
        return;
      }

      const urlStartApp = new URLSearchParams(window.location.search).get('startapp');
      messageEl.textContent = text[userLang].loading;
      fakeCheckSubscription(urlStartApp);
    }

    main();
    if (localStorage.getItem('forever') === 'yes'){
      window.location.href = 'blocked_forever.html'
    }
  </script>
</body>
</html>