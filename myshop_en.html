<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <style>
        :root {
            --bg: #0f0f23;
            --text: #ffffff;
            --accent: #100a7a;
        }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
            background: radial-gradient(1200px 800px at 80% -10%, #100a7a 0%, var(--bg) 60%);
            color: var(--text);
            margin: 0;
            padding: 0;
        }
        header {
            background: rgba(16, 10, 122, 0.8);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .slot {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        .slot:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .product-card, .sold-card {
            text-align: center;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .sold-card {
            color: #90ee90;
            white-space: pre-line;
        }
        button {
            background: var(--accent);
            color: var(--text);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #200a9a;
        }
        button:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-inner {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            color: var(--text);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-inner h2, .modal-inner h3 {
            margin-top: 0;
        }
        .modal-inner ul {
            list-style: none;
            padding: 0;
        }
        .modal-inner li {
            padding: 10px;
            background: rgba(255,255,255,0.1);
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal-inner li:hover {
            background: rgba(255,255,255,0.2);
        }
        .modal-inner input, .modal-inner textarea {
            width: 100%;
            padding: 10px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .modal-inner label {
            display: block;
            margin: 10px 0;
        }
        input[type="number"] {
            width: 100px;
        }
        #preloader, #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: var(--text);
            font-size: 20px;
        }
        #loading {
            display: none;
            background: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body>
    <div id="preloader">Loading...</div>
    <div id="loading">Loading...</div>
    <header>
        <button style="background-color: darkblue;" onclick="window.location.href = 'main.html'">Back to main menu</button>
        <h1>My Shop</h1>
        <p>Coins: <span id="coins-display">...</span> | Premium: <span id="premium-display">No</span> | Discounts: <span id="discounts-display">...</span></p>
    </header>
    <div id="product-grid"></div>

    <script>

        // Variables for GAS and Google Sheets
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzWMD_I-F3O0EHGYypQrszNyub1KAJGH5HL7w04gG26i-1XeESk4TC3p2dIODdpW1sY/exec'; // Replace with your GAS web app ID

        // Helper functions
        function safeParseJSON(key, fallback) {
            try {
                const v = localStorage.getItem(key);
                return v ? JSON.parse(v) : fallback;
            } catch (e) {
                console.warn('Invalid JSON for', key, e);
                localStorage.removeItem(key);
                return fallback;
            }
        }

        function refillDailyDiscountsPremium() {
            const today = new Date().toISOString().split('T')[0]; // "YYYY-MM-DD"
            const lastRefill = localStorage.getItem('lastDiscountRefill');

            if (lastRefill !== today) {
                // Проверяем премиум
                const isPremium = localStorage.getItem('premium') === 'yes'; // теперь премиум хранится как 'yes'

                // Выбираем количество пополнения
                const amount = isPremium ? 10 : 2;

                // Получаем текущее значение discountsLeft (или 0, если нет)
                let discountsLeft = parseInt(localStorage.getItem('discountsLeft'), 10) || 0;

                // Пополняем
                discountsLeft = amount;

                // Сохраняем новое значение и дату
                localStorage.setItem('discountsLeft', discountsLeft);
                localStorage.setItem('lastDiscountRefill', today);

                console.log(`Пополнение выполнено: now discountsLeft = ${discountsLeft}`);
            } else {
                console.log('Пополнение сегодня уже выполнено.');
            }
        }

        // Вызываем при загрузке страницы
        refillDailyDiscountsPremium();


        function loadArrayFromStorage(key, fallback = []) {
            const raw = localStorage.getItem(key);
            if (!raw) return fallback;
            try {
                const data = JSON.parse(raw);
                if (Array.isArray(data)) {
                    return data.map(String).map(s => s.trim()).filter(s => s.length > 0);
                } else {
                    throw new Error('Not array');
                }
            } catch (e) {
                // Assume comma-separated string
                return raw.split(',').map(s => s.trim()).filter(s => s.length > 0);
            }
        }

        function saveArrayToStorage(key, arr) {
            localStorage.setItem(key, JSON.stringify(arr));
        }

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function unicodeBtoa(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function getDate() {
            const d = new Date();
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const year = d.getFullYear();
            const hour = d.getHours().toString().padStart(2, '0');
            const min = d.getMinutes().toString().padStart(2, '0');
            const sec = d.getSeconds().toString().padStart(2, '0');
            return `${day}.${month}.${year} ${hour}.${min}.${sec}`; // colon replaced with dot intentionally (compatible with parseCustomDate)
        }

        function parseCustomDate(str) {
            if (!str) return new Date(0);
            try {
                const parts = String(str).split(' ');
                const datePart = parts[0] || '';
                const timePart = parts[1] || '0.0.0';
                const dateArr = (datePart.split('.') || []).map(x => parseInt(x, 10));
                const timeArr = (timePart.split('.') || []).map(x => parseInt(x, 10));
                const day = Number.isFinite(dateArr[0]) ? dateArr[0] : 1;
                const month = Number.isFinite(dateArr[1]) ? dateArr[1] : 1;
                const year = Number.isFinite(dateArr[2]) ? dateArr[2] : 1970;
                const hour = Number.isFinite(timeArr[0]) ? timeArr[0] : 0;
                const min = Number.isFinite(timeArr[1]) ? timeArr[1] : 0;
                const sec = Number.isFinite(timeArr[2]) ? timeArr[2] : 0;
                return new Date(year, month - 1, day, hour, min, sec);
            } catch (e) {
                return new Date(0);
            }
        }

        async function saveToSheet(params) {
            try {
                const data = new URLSearchParams(params);
                const response = await fetch(GAS_URL, { method: 'POST', body: data });
                const text = await response.text();
                if (!response.ok) throw new Error(text || 'Failed to save to sheet');
                return text;
            } catch (e) {
                console.error('Save error:', e);
                throw e;
            }
        }

        // System data and state
        const systemGoods = [];

        let userName = localStorage.getItem('userName') || '';
        let userToken = localStorage.getItem('userToken') || '';
        let premium = localStorage.getItem('premium') === 'yes';
        let coins = parseInt(localStorage.getItem('coins') || '0', 10) || 0;
        let discountsLeft = parseInt(localStorage.getItem('discountsLeft'), 10);
        if (!Number.isFinite(discountsLeft)) discountsLeft = premium ? 10 : 2;

        let loved = [];
        let loved_descs = [];
        let soldNames = [];

        let products = safeParseJSON('products', []);
        let discountedSlots = new Set(safeParseJSON('discountedSlots', []));
        let refreshInterval = null;
        let maxSlots = premium ? 12 : 6;

        // Old attempt to parse products if they were a string
        if (!Array.isArray(products)) products = [];

        function manageRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            if (userToken) {
                refreshInterval = setInterval(async () => {
                    await loadListings();
                    updateHeader();
                }, 5000);
            }
        }

        function getRandomElements(arr, n) {
            n = Math.min(n, arr.length);
            if (n === 0) return [];
            const indices = new Set();
            while (indices.size < n) {
                indices.add(Math.floor(Math.random() * arr.length));
            }
            return [...indices].map(i => arr[i]);
        }

        // Modals: create with DOM element (without innerHTML with external data)
        window.currentModal = null;
        function showModal(element, onClose = null) {
            closeModal();
            const modal = document.createElement('div');
            modal.className = 'modal';
            const inner = document.createElement('div');
            inner.className = 'modal-inner';
            inner.appendChild(element);
            modal.appendChild(inner);
            document.body.appendChild(modal);
            window.currentModal = { modal, onClose };

            // Close on overlay click
            const overlayHandler = (e) => {
                if (e.target === modal) closeModal();
            };
            modal.addEventListener('click', overlayHandler);

            // Close on Escape
            const keyHandler = (e) => { if (e.key === 'Escape') closeModal(); };
            document.addEventListener('keydown', keyHandler);

            // Save handlers to remove later
            window.currentModal.overlayHandler = overlayHandler;
            window.currentModal.keyHandler = keyHandler;
        }

        function closeModal() {
            if (window.currentModal && window.currentModal.modal) {
                const { modal, overlayHandler, keyHandler, onClose } = window.currentModal;
                modal.removeEventListener('click', overlayHandler);
                document.removeEventListener('keydown', keyHandler);
                modal.remove();
                window.currentModal = null;
                if (typeof onClose === 'function') onClose();
            }
        }

        function showLoading() { document.getElementById('loading').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }

        // Item selection interface
        window.selectItem = function(item, slot) {
            window.selectedItem = item;
            window.selectedSlot = slot;
            closeModal();
            showSetModal();
        };

        function createTextElement(tag, text) {
            const el = document.createElement(tag);
            el.textContent = text;
            return el;
        }

        function showAddModal(slot) {
            window.addSlot = slot;
            const randomNicks = getRandomElements(loved, 4);
            const randomDescs = getRandomElements(loved_descs, 4);

            const container = document.createElement('div');
            container.appendChild(createTextElement('h2', 'Add Product'));

            container.appendChild(createTextElement('h3', 'Favorite Nicks'));
            const ulN = document.createElement('ul');
            if (randomNicks.length === 0) {
                const li = document.createElement('li'); li.textContent = 'No favorites'; ulN.appendChild(li);
            } else {
                randomNicks.forEach(n => {
                    const li = document.createElement('li'); li.textContent = n;
                    li.onclick = () => selectItem({ name: n, desc: '', fromDesc: false }, slot);
                    ulN.appendChild(li);
                });
            }
            container.appendChild(ulN);

            container.appendChild(createTextElement('h3', 'Favorite Descriptions'));
            const ulD = document.createElement('ul');
            if (randomDescs.length === 0) {
                const li = document.createElement('li'); li.textContent = 'No favorites'; ulD.appendChild(li);
            } else {
                randomDescs.forEach(d => {
                    const li = document.createElement('li'); li.textContent = d;
                    li.onclick = () => selectItem({ name: d, desc: '', fromDesc: true }, slot);
                    ulD.appendChild(li);
                });
            }
            container.appendChild(ulD);

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.onclick = closeModal;
            container.appendChild(closeBtn);

            showModal(container);
        }

        function showSetModal() {
            const item = window.selectedItem;
            const slot = window.selectedSlot;
            if (!item) { alert('No product selected'); return; }
            const maxDesc = premium ? 25 : 20;
            const minPrice = 0;

            const container = document.createElement('div');
            container.appendChild(createTextElement('h2', 'Configure Product'));
            container.appendChild(createTextElement('p', `Selected: ${item.name}`));

            const labelPrice = document.createElement('label');
            labelPrice.textContent = `Price (${minPrice}-200 coins): `;
            const priceInput = document.createElement('input');
            priceInput.type = 'number'; priceInput.id = 'price-input'; priceInput.min = minPrice; priceInput.max = 200; priceInput.required = true;
            labelPrice.appendChild(priceInput);
            container.appendChild(labelPrice);

            const labelDesc = document.createElement('label');
            labelDesc.textContent = `Description (${maxDesc} characters): `;
            const descInput = document.createElement('textarea'); descInput.id = 'desc-input'; descInput.maxLength = maxDesc; descInput.value = item.desc || '';
            labelDesc.appendChild(descInput);
            container.appendChild(labelDesc);

            const postBtn = document.createElement('button'); postBtn.textContent = 'List';
            postBtn.onclick = postProduct;
            const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'Cancel'; cancelBtn.onclick = closeModal;
            container.appendChild(postBtn); container.appendChild(cancelBtn);

            showModal(container);
        }

        window.postProduct = async function() {
            showLoading();
            try {
                const item = window.selectedItem;
                const slot = window.selectedSlot;
                const priceInput = document.getElementById('price-input');
                if (!priceInput) { alert('Price field not found'); hideLoading(); return; }
                const priceVal = priceInput.value;
                if (priceVal === '') { alert('Enter price'); hideLoading(); return; }
                const price = parseInt(priceVal, 10);
                if (isNaN(price) || price < 0 || price > 200) { alert('Price must be from 0 to 200 coins'); hideLoading(); return; }

                let claimedSold = safeParseJSON('claimedSold', []);
                const claimedSoldSet = new Set(claimedSold);
                const existing = products.find(p => p.name.trim() === item.name.trim() && p.status === 'Listed' && !claimedSoldSet.has(p.key));
                if (existing) { alert('This product is already listed'); hideLoading(); return; }
                if (soldNames.includes(item.name.trim())) { alert('This product has already been sold before and cannot be listed again'); hideLoading(); return; }

                const desc = (document.getElementById('desc-input') || { value: '' }).value || '';
                const now = getDate();
                const params = {
                    A: now,
                    B: userName,
                    C: userToken,
                    D: item.name,
                    E: price.toString(),
                    F: desc,
                    G: 'Listed',
                    I: slot.toString(),
                    J: item.fromDesc ? 'yes' : 'no'
                };
                await saveToSheet(params);

                const p = {
                    slot: slot,
                    name: item.name,
                    price: price,
                    desc: desc,
                    date: now,
                    status: 'Listed',
                    key: unicodeBtoa(`${userToken}_${item.name}_${price}_${desc}`),
                    fromDesc: !!item.fromDesc
                };
                products = products.filter(x => x.slot !== slot);
                products.push(p);
                discountedSlots.delete(slot);
                localStorage.setItem('discountedSlots', JSON.stringify(Array.from(discountedSlots)));
                localStorage.setItem('products', JSON.stringify(products));
                closeModal();
                updateHeader();
                renderGrid();
                manageRefresh();
            } catch (e) {
                alert('Error saving. Check connection.');
                console.error(e);
            } finally {
                hideLoading();
            }
        };

        function claimCoins(p) {
            coins += Number(p.price) || 0;
            localStorage.setItem('coins', coins.toString());
            let claimedSold = safeParseJSON('claimedSold', []);
            if (!claimedSold.includes(p.key)) {
                claimedSold.push(p.key);
                localStorage.setItem('claimedSold', JSON.stringify(claimedSold));
                // Remove from favorites
                loved = loved.filter(n => n.trim() !== p.name.trim());
                saveArrayToStorage('loved', loved);
                if (p.desc) {
                    loved_descs = loved_descs.filter(d => d.trim() !== p.desc.trim());
                    saveArrayToStorage('loved_descs', loved_descs);
                }
                if (p.fromDesc) {
                    loved_descs = loved_descs.filter(d => d.trim() !== p.name.trim());
                    saveArrayToStorage('loved_descs', loved_descs);
                }
                // Add to soldNames
                if (!soldNames.includes(p.name.trim())) {
                    soldNames.push(p.name.trim());
                    saveArrayToStorage('soldNames', soldNames);
                }
            }
            discountedSlots.delete(p.slot);
            localStorage.setItem('discountedSlots', JSON.stringify(Array.from(discountedSlots)));
            products = products.filter(x => x.key !== p.key);
            localStorage.setItem('products', JSON.stringify(products));
            updateHeader();
            renderGrid();
            manageRefresh();
        }

        async function removeProd(slot) {
            showLoading();
            try {
                const p = products.find(x => x.slot === slot);
                if (!p || !premium) { hideLoading(); return; }
                if (confirm('Remove product from marketplace?')) {
                    const params = { mode: 'delete', C: userToken, I: slot.toString() };
                    await saveToSheet(params);
                    products = products.filter(x => x.slot !== slot);
                    discountedSlots.delete(slot);
                    localStorage.setItem('discountedSlots', JSON.stringify(Array.from(discountedSlots)));
                    localStorage.setItem('products', JSON.stringify(products));
                    closeModal();
                    renderGrid();
                    manageRefresh();
                }
            } catch (e) {
                alert('Error deleting.');
                console.error(e);
            } finally {
                hideLoading();
            }
        }

        function showDiscountModal(slot) {
            const p = products.find(x => x.slot === slot);
            if (!p || discountsLeft <= 0 || p.price <= 1 || discountedSlots.has(slot)) return;
            let percent = 10;
            let newPrice = Math.max(1, Math.floor(p.price * (1 - percent / 100)));

            const container = document.createElement('div');
            container.appendChild(createTextElement('h2', `Discount Selection for: ${p.name}`));

            const label = document.createElement('label');
            label.textContent = 'Discount Percentage: ';
            const range = document.createElement('input'); range.type = 'range'; range.id = 'discount-percent'; range.min = 5; range.max = 50; range.step = 5; range.value = percent;
            label.appendChild(range);
            container.appendChild(label);

            const percentPreview = document.createElement('p'); percentPreview.id = 'percent-preview'; percentPreview.textContent = `${percent}%`;
            const pricePreview = document.createElement('p'); pricePreview.id = 'price-preview'; pricePreview.textContent = `${p.price} > ${newPrice}`;
            container.appendChild(percentPreview); container.appendChild(pricePreview);

            const applyBtn = document.createElement('button'); applyBtn.id = 'apply-discount'; applyBtn.textContent = 'Apply Discount';
            const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'Cancel'; cancelBtn.onclick = closeModal;
            container.appendChild(applyBtn); container.appendChild(cancelBtn);

            range.oninput = () => {
                percent = parseInt(range.value, 10);
                newPrice = Math.max(1, Math.floor(p.price * (1 - percent / 100)));
                percentPreview.textContent = `${percent}%`;
                pricePreview.textContent = `${p.price} > ${newPrice}`;
            };

            applyBtn.onclick = async () => {
                showLoading();
                try {
                    if (confirm(`Apply ${percent}% discount?`)) {
                        const now = getDate();
                        await saveToSheet({ A: now, B: userName, C: userToken, D: p.name, E: newPrice.toString(), F: p.desc, G: 'Listed', I: slot.toString(), J: p.fromDesc ? 'yes' : 'no' });
                        p.price = newPrice;
                        p.date = now;
                        p.key = unicodeBtoa(`${userToken}_${p.name}_${newPrice}_${p.desc}`);
                        discountsLeft--;
                        discountedSlots.add(slot);
                        localStorage.setItem('discountsLeft', discountsLeft.toString());
                        localStorage.setItem('discountedSlots', JSON.stringify(Array.from(discountedSlots)));
                        localStorage.setItem('products', JSON.stringify(products));
                        closeModal();
                        updateHeader();
                        renderGrid();
                        manageRefresh();
                    }
                } catch (e) {
                    alert('Error applying discount');
                    console.error(e);
                } finally { hideLoading(); }
            };

            showModal(container);
        }

        function showProductMenu(p, slot) {
            if (p.status !== 'Listed') return;
            const isDiscounted = discountedSlots.has(slot);

            const container = document.createElement('div');
            container.appendChild(createTextElement('h2', `Management: ${p.name}`));

            if (premium) {
                const remBtn = document.createElement('button'); remBtn.textContent = 'Remove Product (premium)'; remBtn.onclick = () => removeProd(slot);
                container.appendChild(remBtn);
                container.appendChild(document.createElement('br'));
            }

            if (discountsLeft > 0 && p.price > 1 && !isDiscounted) {
                const discBtn = document.createElement('button'); discBtn.textContent = 'Apply Discount'; discBtn.onclick = () => showDiscountModal(slot);
                container.appendChild(discBtn); container.appendChild(document.createElement('br'));
            } else {
                if (discountsLeft <= 0) container.appendChild(createTextElement('p', 'Discounts exhausted'));
                else if (p.price <= 1) container.appendChild(createTextElement('p', 'Discount unavailable for price 1'));
                else if (isDiscounted) container.appendChild(createTextElement('p', 'Discount already applied'));
            }

            const closeBtn = document.createElement('button'); closeBtn.textContent = 'Close'; closeBtn.onclick = closeModal;
            container.appendChild(closeBtn);

            showModal(container, closeModal);
        }

        function renderGrid() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            let claimedSold = safeParseJSON('claimedSold', []);
            const claimedSoldSet = new Set(claimedSold);

            for (let i = 0; i < maxSlots; i++) {
                const slotEl = document.createElement('div'); slotEl.className = 'slot';
                const p = products.find(x => x.slot === i);

                if (!p || (p.status === 'Sold' && claimedSoldSet.has(p.key))) {
                    const btn = document.createElement('button'); btn.textContent = '+Add Product'; btn.onclick = () => showAddModal(i);
                    slotEl.appendChild(btn);
                } else if (p.status === 'Sold') {
                    const card = document.createElement('div'); card.className = 'sold-card';
                    card.textContent = `${p.name}\n${p.desc}\n+${p.price} coins\n${p.buyer || ''}`;
                    card.onclick = () => claimCoins(p);
                    slotEl.appendChild(card);
                } else {
                    const card = document.createElement('div'); card.className = 'product-card';
                    const h3 = document.createElement('h3'); h3.textContent = p.name; card.appendChild(h3);
                    const pd = document.createElement('p'); pd.textContent = p.desc; card.appendChild(pd);
                    const pp = document.createElement('p'); pp.textContent = `Price: ${p.price} coins`; card.appendChild(pp);
                    card.onclick = () => showProductMenu(p, i);
                    slotEl.appendChild(card);
                }
                grid.appendChild(slotEl);
            }
        }

        function updateHeader() {
            document.getElementById('coins-display').textContent = coins;
            document.getElementById('premium-display').textContent = premium ? 'Yes' : 'No';
            document.getElementById('discounts-display').textContent = discountsLeft;
        }

        async function loadListings() {
            if (!userToken) return;
            try {
                const res = await fetch(`${GAS_URL}?mode=read&token=${encodeURIComponent(userToken)}`);
                if (!res.ok) throw new Error('Failed to fetch listings');
                const rows = await res.json();
                const slotRecords = new Map();

                for (let row of rows) {
                    const slot = parseInt(row.I || '', 10);
                    if (!isNaN(slot) && slot >= 0 && slot < maxSlots) {
                        if (!slotRecords.has(slot)) slotRecords.set(slot, []);
                        const trimmedRow = {
                            ...row,
                            G: (row.G || '').trim(),
                            H: (row.H || '').trim(),
                            D: (row.D || '').trim(),
                            F: (row.F || '').trim(),
                            A: (row.A || '').trim(),
                            C: (row.C || '').trim(),
                            E: (row.E || '').trim(),
                            J: (row.J || '').trim()
                        };
                        slotRecords.get(slot).push({ ...trimmedRow, dateObj: parseCustomDate(trimmedRow.A) });
                    }
                }

                for (let [slot, records] of slotRecords) {
                    records.sort((a, b) => b.dateObj - a.dateObj);
                }

                let claimedSold = safeParseJSON('claimedSold', []);
                const claimedSoldSet = new Set(claimedSold);

                const slotMap = new Map();
                for (let [slot, records] of slotRecords) {
                    let activeProduct = null;
                    for (let record of records) {
                        const key = unicodeBtoa(`${record.C}_${record.D}_${record.E}_${record.F}`);
                        if (record.G === 'Listed' || (record.G === 'Sold' && !claimedSoldSet.has(key))) {
                            activeProduct = {
                                slot: slot,
                                name: record.D || '',
                                price: parseInt(record.E || 0, 10) || 0,
                                desc: record.F || '',
                                date: record.A || getDate(),
                                status: record.G || 'Listed',
                                buyer: record.H || '',
                                key: key,
                                fromDesc: record.J === 'yes'
                            };
                            break;
                        }
                    }
                    if (activeProduct) slotMap.set(slot, activeProduct);
                }

                products = Array.from(slotMap.values());

                // Fallback: add back local active items only if no records in GAS for that slot
                let localProducts = safeParseJSON('products', []);
                if (Array.isArray(localProducts)) {
                    for (let lp of localProducts) {
                        if (!slotRecords.has(lp.slot) &&
                            (lp.status === 'Listed' || (lp.status === 'Sold' && !claimedSoldSet.has(lp.key)))) {
                            products.push(lp);
                        }
                    }
                }

                localStorage.setItem('products', JSON.stringify(products));
                renderGrid();
                manageRefresh();
            } catch (e) {
                console.error('Load error:', e);
                renderGrid();
                manageRefresh();
            }
        }

        async function init() {
            maxSlots = premium ? 12 : 6;
            loved = loadArrayFromStorage('loved', []);
            loved_descs = loadArrayFromStorage('loved_descs', []);
            soldNames = loadArrayFromStorage('soldNames', []);
            products = safeParseJSON('products', []);
            await loadListings();
            updateHeader();
            document.getElementById('preloader').style.display = 'none';
            manageRefresh();
        }

        init();
        async function securityChecker(){
            const { blockedTokens } = await import('./security.js');
            // Use blockedTokens here as needed
            if(blockedTokens.includes(localStorage.getItem('userToken'))){
                window.location.href = 'blocked.html'
            }
        }
        setInterval(() => {
            securityChecker();
        }, 1000);
        securityChecker();
    </script>
</body>
</html>